# name: Build & deploy SSR to Azure Container Apps

# on:
#   push:
#     branches: [ master ]
#   workflow_dispatch:

# permissions:
#   id-token: write
#   contents: read

# env:
#   RESOURCE_GROUP: ICare_group
#   LOCATION: westeurope
#   CONTAINERAPPS_ENV: icare-aca-env
#   CONTAINERAPP_NAME: icare-ssr
#   ACR_NAME: icareacr12345
#   IMAGE_NAME: icare-ssr

# jobs:
#   build_and_deploy:
#     runs-on: ubuntu-latest
#     steps:
#       - uses: actions/checkout@v4

#       - name: Azure login (OIDC)
#         uses: azure/login@v2
#         with:
#           client-id: ${{ secrets.AZUREAPPSERVICE_CLIENTID_7961A8A59D004D42BA1A30149976E086 }}
#           tenant-id: ${{ secrets.AZUREAPPSERVICE_TENANTID_3528E4C9D9704243A6471042CCA96203 }}
#           subscription-id: ${{ secrets.AZUREAPPSERVICE_SUBSCRIPTIONID_A259613877694B3AB75FDE52F53CDB34 }}

#       - name: Show Azure context
#         run: |
#           az account show -o table
#           az group show -n $RESOURCE_GROUP -o table
#           az containerapp env list -g $RESOURCE_GROUP -o table


#       - name: Login to ACR
#         run: |
#           az acr login --name $ACR_NAME

#       - name: Build and push image
#         run: |
#           IMAGE="$ACR_NAME.azurecr.io/$IMAGE_NAME:${{ github.sha }}"
#           docker build -t "$IMAGE" .
#           docker push "$IMAGE"
#           echo "IMAGE=$IMAGE" >> $GITHUB_ENV

#       - name: Deploy to Azure Container Apps
#         run: |
#           az containerapp create \
#             --name $CONTAINERAPP_NAME \
#             --resource-group $RESOURCE_GROUP \
#             --environment $CONTAINERAPPS_ENV \
#             --image $IMAGE \
#             --ingress external \
#             --target-port 8080 \
#             --cpu 0.5 \
#             --memory 1.0Gi \
#             --min-replicas 0 \
#             --max-replicas 1 \
#             --query properties.configuration.ingress.fqdn -o tsv

#       - name: Update image (on subsequent deploys)
#         run: |
#           az containerapp update \
#             --name $CONTAINERAPP_NAME \
#             --resource-group $RESOURCE_GROUP \
#             --image $IMAGE
